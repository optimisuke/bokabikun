<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bokabikun</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="color-scheme" content="light dark" />
  </head>

  <body class="min-h-screen bg-slate-50 text-slate-900">
    <header
      class="sticky top-0 z-10 border-b border-slate-200 bg-white/80 backdrop-blur"
    >
      <div
        class="mx-auto flex max-w-3xl items-center justify-between gap-3 px-4 py-3"
      >
        <div class="flex items-center gap-3">
          <div
            class="grid h-10 w-10 place-items-center rounded-xl bg-gradient-to-r from-emerald-400 to-sky-400 text-white shadow-sm"
            aria-hidden="true"
          >
            ğŸ‘»
          </div>
          <div>
            <h1 class="text-lg font-semibold leading-tight">
              ã‚¿ã‚¹ã‚¯ç®¡ç† Bokabi-kun
            </h1>
            <p class="text-xs text-slate-500">ã‚†ã‚‹ãç®¡ç†ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚¢ãƒ—ãƒª</p>
          </div>
        </div>

        <div class="flex items-center gap-2"></div>
      </div>
    </header>

    <main class="mx-auto max-w-3xl px-4 py-6 pb-24">
      <!-- List -->
      <section>
        <div class="mb-3 flex items-center justify-between">
          <h2 class="text-sm font-semibold text-slate-700">ä¸€è¦§</h2>
          <div class="flex items-center gap-2 text-xs text-slate-500">
            <span id="countText">0ä»¶</span>
            <span class="inline-block h-1 w-1 rounded-full bg-slate-300"></span>
            <span id="updatedText">â€”</span>
          </div>
        </div>

        <div
          id="emptyState"
          class="hidden rounded-2xl border border-dashed border-slate-300 bg-white p-8 text-center"
        >
          <p class="text-sm font-medium text-slate-700">ã‚¿ã‚¹ã‚¯ãªã—</p>
          <p class="mt-1 text-xs text-slate-500">ï¼‹ã§è¿½åŠ </p>
        </div>

        <div id="list" class="grid gap-3"></div>
      </section>
    </main>
    <button
      id="btnAddFab"
      class="fixed bottom-4 right-4 z-30 inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-emerald-400 to-sky-400 px-4 py-3 text-sm font-medium text-white shadow-lg shadow-emerald-500/20 hover:from-emerald-500 hover:to-sky-500 active:from-emerald-600 active:to-sky-600"
      aria-label="ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ "
    >
      ï¼‹ è¿½åŠ 
    </button>

    <div
      id="toast"
      class="fixed bottom-20 right-4 z-30 hidden max-w-xs items-center gap-3 rounded-2xl bg-white px-4 py-3 text-sm text-slate-800 shadow-lg ring-1 ring-slate-200 flex"
    >
      <span id="toastMessage" class="font-medium"></span>
      <button
        id="btnUndo"
        class="ml-auto rounded-xl border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-600 hover:bg-slate-50"
      >
        å–ã‚Šæ¶ˆã™
      </button>
    </div>

    <!-- Modal -->
    <div id="modalBackdrop" class="fixed inset-0 z-20 hidden bg-black/40 p-4">
      <div class="mx-auto mt-10 max-w-md">
        <div class="rounded-2xl bg-white shadow-xl ring-1 ring-slate-200">
          <div
            class="flex items-center justify-between border-b border-slate-200 px-4 py-3"
          >
            <h3 id="modalTitle" class="text-sm font-semibold text-slate-800">
              ã‚¿ã‚¹ã‚¯
            </h3>
            <button
              id="btnCloseModal"
              class="rounded-xl px-3 py-2 text-sm text-slate-500 hover:bg-slate-100"
            >
              âœ•
            </button>
          </div>

          <form id="taskForm" class="space-y-4 p-4">
            <input type="hidden" id="taskId" />

            <div>
              <label class="text-xs font-medium text-slate-600">åå‰</label>
              <input
                id="taskName"
                type="text"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400"
                placeholder="ä¾‹ï¼‰é˜²ã‚«ãƒ“ãã‚“ / æµ„æ°´å™¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
                required
                maxlength="40"
              />
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-medium text-slate-600"
                  >å‘¨æœŸï¼ˆæ—¥ï¼‰</label
                >
                <input
                  id="taskInterval"
                  type="number"
                  min="1"
                  max="999"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400"
                  placeholder="ä¾‹ï¼‰45"
                  required
                />
              </div>

              <div>
                <label class="text-xs font-medium text-slate-600"
                  >å‰å›å®Ÿæ–½æ—¥</label
                >
                <input
                  id="taskLastDone"
                  type="date"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400"
                  required
                />
              </div>
            </div>

            <div>
              <label class="text-xs font-medium text-slate-600"
                >ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label
              >
              <textarea
                id="taskNote"
                rows="2"
                class="mt-1 w-full resize-none rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400"
                placeholder="ä¾‹ï¼‰æ›æ°—æ‰‡ã‚’å›ã—ã¦ã‹ã‚‰ã€‚"
                maxlength="160"
              ></textarea>
              <p class="mt-1 text-[11px] text-slate-400">
                â€» ã“ã®ç«¯æœ«å†…ã«ã ã‘ä¿å­˜ã•ã‚Œã¾ã™
              </p>
            </div>

            <div class="flex items-center justify-between gap-2 pt-1">
              <button
                id="btnDelete"
                type="button"
                class="hidden rounded-xl border border-red-200 bg-white px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50"
              >
                å‰Šé™¤
              </button>

              <div class="ml-auto flex items-center gap-2">
                <button
                  id="btnCancel"
                  type="button"
                  class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                  type="submit"
                  class="rounded-xl bg-gradient-to-r from-emerald-400 to-sky-400 px-4 py-2 text-sm font-medium text-white shadow-sm hover:from-emerald-500 hover:to-sky-500 active:from-emerald-600 active:to-sky-600"
                >
                  ä¿å­˜
                </button>
              </div>
            </div>
          </form>
        </div>

        <p class="mt-3 text-center text-xs text-white/80">
          ãƒ’ãƒ³ãƒˆï¼šã€Œã‚„ã£ãŸï¼ã€ã§æ›´æ–°
        </p>
      </div>
    </div>

    <script>
      // ===== Storage =====
      const STORAGE_KEY = "bokabikun.tasks.v1";

      /** @typedef {{id:string,name:string,intervalDays:number,lastDone:string,note?:string,createdAt:string,updatedAt:string}} Task */

      /** @returns {Task[]} */
      function loadTasks() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        try {
          const data = JSON.parse(raw);
          if (!Array.isArray(data)) return [];
          return data;
        } catch {
          return [];
        }
      }

      /** @param {Task[]} tasks */
      function saveTasks(tasks) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        localStorage.setItem("bokabikun.updatedAt", new Date().toISOString());
      }

      function nowISODate() {
        // local date -> YYYY-MM-DD
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function daysBetween(fromISO, toISO) {
        const from = new Date(fromISO + "T00:00:00");
        const to = new Date(toISO + "T00:00:00");
        const ms = to - from;
        return Math.floor(ms / (1000 * 60 * 60 * 24));
      }

      function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
      }

      function uid() {
        // good enough for local
        return (
          Math.random().toString(16).slice(2) + "-" + Date.now().toString(16)
        );
      }

      // ===== UI =====
      const elList = document.getElementById("list");
      const elEmpty = document.getElementById("emptyState");
      const elCountText = document.getElementById("countText");
      const elUpdatedText = document.getElementById("updatedText");

      const btnAddFab = document.getElementById("btnAddFab");

      const toast = document.getElementById("toast");
      const toastMessage = document.getElementById("toastMessage");
      const btnUndo = document.getElementById("btnUndo");

      const backdrop = document.getElementById("modalBackdrop");
      const btnCloseModal = document.getElementById("btnCloseModal");
      const btnCancel = document.getElementById("btnCancel");
      const btnDelete = document.getElementById("btnDelete");
      const modalTitle = document.getElementById("modalTitle");

      const form = document.getElementById("taskForm");
      const inputId = document.getElementById("taskId");
      const inputName = document.getElementById("taskName");
      const inputInterval = document.getElementById("taskInterval");
      const inputLastDone = document.getElementById("taskLastDone");
      const inputNote = document.getElementById("taskNote");

      /** @type {Task[]} */
      let tasks = loadTasks();
      let lastAction = null;
      let toastTimer = null;

      function formatUpdatedAt() {
        const raw = localStorage.getItem("bokabikun.updatedAt");
        if (!raw) return "æ›´æ–°: â€”";
        const d = new Date(raw);
        if (Number.isNaN(d.getTime())) return "æ›´æ–°: â€”";
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `æ›´æ–°: ${y}-${m}-${day} ${hh}:${mm}`;
      }

      function statusBadge(elapsed, interval) {
        // - due: çµŒé >= interval
        // - soon: çµŒé >= 0.75*interval
        if (elapsed >= interval) {
          return {
            label: "ã‚„ã£ã¨ãï¼Ÿ",
            cls: "bg-rose-50 text-rose-700 ring-1 ring-rose-200",
          };
        }
        if (elapsed >= Math.floor(interval * 0.75)) {
          return {
            label: "ã¼ã¡ã¼ã¡ã‚„ã§",
            cls: "bg-amber-50 text-amber-700 ring-1 ring-amber-200",
          };
        }
        return null;
      }

      function render() {
        tasks = loadTasks();

        // sort: most urgent first
        const today = nowISODate();
        const sorted = [...tasks].sort((a, b) => {
          const ea = daysBetween(a.lastDone, today) / a.intervalDays;
          const eb = daysBetween(b.lastDone, today) / b.intervalDays;
          return eb - ea;
        });

        elList.innerHTML = "";
        elCountText.textContent = `${sorted.length}ä»¶`;
        elUpdatedText.textContent = formatUpdatedAt();

        if (sorted.length === 0) {
          elEmpty.classList.remove("hidden");
        } else {
          elEmpty.classList.add("hidden");
        }

        for (const t of sorted) {
          const elapsed = clamp(daysBetween(t.lastDone, today), 0, 99999);
          const remain = t.intervalDays - elapsed;
          const ratio = Math.round((elapsed / t.intervalDays) * 100);

          const badge = statusBadge(elapsed, t.intervalDays);
          const badgeHtml = badge
            ? `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium ${badge.cls}">
                ${badge.label}
              </span>`
            : "";

          const card = document.createElement("div");
          card.dataset.taskId = t.id;
          card.className =
            "cursor-pointer rounded-2xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow transition-shadow";

          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <h3 class="truncate text-base font-semibold text-slate-900">${escapeHtml(
                    t.name
                  )}</h3>
                  ${badgeHtml}
                </div>
                <p class="mt-1 text-xs text-slate-500">
                  å‰å›: <span class="font-medium text-slate-700">${
                    t.lastDone
                  }</span>
                  ãƒ» å‘¨æœŸ: <span class="font-medium text-slate-700">${
                    t.intervalDays
                  }æ—¥</span>
                </p>
                ${
                  t.note
                    ? `<p class="mt-2 line-clamp-2 text-sm text-slate-700">${escapeHtml(
                        t.note
                      )}</p>`
                    : ""
                }
              </div>

              <div class="flex shrink-0 flex-col items-end gap-2">
                <button
                  data-action="done"
                  data-id="${t.id}"
                  class="rounded-xl bg-gradient-to-r from-emerald-400 to-sky-400 px-3 py-2 text-sm font-medium text-white shadow-sm hover:from-emerald-500 hover:to-sky-500 active:from-emerald-600 active:to-sky-600"
                  title="å‰å›å®Ÿæ–½æ—¥ã‚’ä»Šæ—¥ã«æ›´æ–°"
                >
                  ã‚„ã£ãŸï¼
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="flex items-center justify-between text-[11px] text-slate-500">
                <span>${
                  remain >= 0
                    ? `ã‚ã¨ ${remain}æ—¥`
                    : `è¶…é ${Math.abs(remain)}æ—¥ï¼ˆæ°—ã«ã—ãªã„ï¼‰`
                }</span>
                <span>${clamp(ratio, 0, 999)}%</span>
              </div>
              <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-slate-100">
                <div class="h-full rounded-full bg-gradient-to-r from-emerald-400 to-sky-400" style="width:${clamp(
                  ratio,
                  0,
                  100
                )}%"></div>
              </div>
            </div>
          `;

          elList.appendChild(card);
        }
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function openModal(mode, task) {
        backdrop.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");

        if (mode === "create") {
          modalTitle.textContent = "ã‚¿ã‚¹ã‚¯è¿½åŠ ";
          btnDelete.classList.add("hidden");
          inputId.value = "";
          inputName.value = "";
          inputInterval.value = "45";
          inputLastDone.value = nowISODate();
          inputNote.value = "";
          inputName.focus();
          return;
        }

        modalTitle.textContent = "ã‚¿ã‚¹ã‚¯ç·¨é›†";
        btnDelete.classList.remove("hidden");
        inputId.value = task.id;
        inputName.value = task.name;
        inputInterval.value = String(task.intervalDays);
        inputLastDone.value = task.lastDone;
        inputNote.value = task.note || "";
        inputName.focus();
      }

      function closeModal() {
        backdrop.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }

      function showToast(message, canUndo) {
        toastMessage.textContent = message;
        if (canUndo) {
          btnUndo.classList.remove("hidden");
        } else {
          btnUndo.classList.add("hidden");
        }
        toast.classList.remove("hidden");
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toast.classList.add("hidden");
        }, 5000);
      }

      function upsertTask(task) {
        const all = loadTasks();
        const idx = all.findIndex((t) => t.id === task.id);
        if (idx >= 0) {
          all[idx] = task;
        } else {
          all.push(task);
        }
        saveTasks(all);
      }

      function deleteTask(id) {
        const all = loadTasks().filter((t) => t.id !== id);
        saveTasks(all);
      }

      function findTask(id) {
        return loadTasks().find((t) => t.id === id);
      }

      // ===== Events =====
      btnAddFab.addEventListener("click", () => openModal("create"));

      btnCloseModal.addEventListener("click", closeModal);
      btnCancel.addEventListener("click", closeModal);
      document.addEventListener("click", (e) => {
        if (toast.classList.contains("hidden")) return;
        if (e.target.closest('[data-action="done"]')) return;
        if (toast.contains(e.target)) return;
        toast.classList.add("hidden");
        if (toastTimer) clearTimeout(toastTimer);
      });
      btnUndo.addEventListener("click", () => {
        if (!lastAction) return;
        const t = findTask(lastAction.id);
        if (!t) return;
        t.lastDone = lastAction.lastDone;
        t.updatedAt = lastAction.updatedAt;
        upsertTask(t);
        lastAction = null;
        toast.classList.add("hidden");
        render();
      });

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !backdrop.classList.contains("hidden"))
          closeModal();
      });

      btnDelete.addEventListener("click", () => {
        const id = inputId.value;
        if (!id) return;
        // ã‚†ã‚‹ã„ã‚¢ãƒ—ãƒªãªã®ã§ confirm ã ã‘
        if (confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          deleteTask(id);
          closeModal();
          render();
        }
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const id = inputId.value || uid();
        const name = inputName.value.trim();
        const intervalDays = Number(inputInterval.value);
        const lastDone = inputLastDone.value;
        const note = inputNote.value.trim();

        if (!name) return;
        if (!Number.isFinite(intervalDays) || intervalDays < 1) return;
        if (!lastDone) return;

        const existing = findTask(id);
        const createdAt = existing?.createdAt || new Date().toISOString();

        /** @type {Task} */
        const task = {
          id,
          name,
          intervalDays,
          lastDone,
          note: note || "",
          createdAt,
          updatedAt: new Date().toISOString(),
        };

        upsertTask(task);
        closeModal();
        render();
      });

      elList.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        const action = btn?.getAttribute("data-action");
        const id = btn?.getAttribute("data-id");

        if (action === "done" && id) {
          const t = findTask(id);
          if (!t) return;
          lastAction = {
            id: t.id,
            lastDone: t.lastDone,
            updatedAt: t.updatedAt,
          };
          t.lastDone = nowISODate();
          t.updatedAt = new Date().toISOString();
          upsertTask(t);
          render();
          showToast("ğŸ‰ æ›´æ–°ã—ãŸã‚ˆ", true);
          return;
        }

        const card = e.target.closest("[data-task-id]");
        const cardId = card?.getAttribute("data-task-id");
        if (!cardId) return;
        const t = findTask(cardId);
        if (t) openModal("edit", t);
      });

      // Initial render
      if (!localStorage.getItem("bokabikun.updatedAt")) {
        localStorage.setItem("bokabikun.updatedAt", new Date().toISOString());
      }
      if (!localStorage.getItem(STORAGE_KEY)) {
        const today = nowISODate();
        const sample = [
          {
            id: uid(),
            name: "é˜²ã‚«ãƒ“ãã‚“",
            intervalDays: 60,
            lastDone: today,
            note: "ãŸã¾ã«ã¯ã‚„ã‚ã†",
          },
        ].map((t) => ({
          ...t,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        }));

        saveTasks(sample);
      }
      render();

      // PWA service worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").catch(() => {
            // ignore registration errors for local file or unsupported environments
          });
        });
      }
    </script>
  </body>
</html>
